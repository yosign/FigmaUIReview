<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UI Review Plugin</title>
  <style>
    body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: white;
      color: #333;
    }

    .space-y-6 > * + * {
      margin-top: 1rem;
    }

    .section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    .section:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-content {
      padding: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.875rem;
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      outline: none;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: #7c3aed;
      color: white;
    }

    .btn-primary:hover {
      background-color: #6d28d9;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
      background-color: #f3f4f6;
      color: #374151;
      gap: 0.25rem;
    }

    .badge-purple {
      background-color: #f5f3ff;
      color: #7c3aed;
    }

    .style-list {
      max-height: 120px;
      overflow-y: auto;
      margin-bottom: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      padding: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .style-item {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
      background: white;
      font-size: 0.75rem;
      min-width: calc(33.333% - 0.5rem);
      flex: 0 1 auto;
    }

    .style-item:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }

    .style-item.selected {
      background-color: #f5f3ff;
      border-color: #7c3aed;
    }

    .style-checkbox {
      width: 0.875rem;
      height: 0.875rem;
      margin-right: 0.5rem;
      border-radius: 3px;
      border: 2px solid #d1d5db;
      position: relative;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .style-checkbox:checked {
      background-color: #7c3aed;
      border-color: #7c3aed;
    }

    .style-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 1px;
      width: 3px;
      height: 6px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .style-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .issue-item {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      padding: 1rem;
      transition: all 0.2s ease;
    }

    .issue-item:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .issue-header {
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .issue-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      background-color: #f9fafb;
      padding: 0.75rem;
      border-radius: 6px;
      margin: 0.75rem 0;
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
      font-size: 0.875rem;
    }

    .fix-button {
      background-color: #7c3aed;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .fix-button:hover {
      background-color: #6d28d9;
    }

    .fix-all-button {
      background-color: #7c3aed;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .fix-all-button:hover {
      background-color: #6d28d9;
    }

    .go-button {
      background-color: #10b981;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      margin-left: 0.5rem;
    }

    .go-button:hover {
      background-color: #059669;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .stat-item {
      background-color: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      background-color: #f3f4f6;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .logo {
      height: 36px;
      width: auto;
      margin-bottom: 1rem;
      display: block;
    }

    .logo > div {
      height: 36px;
    }

    .logo svg {
      height: 36px;
      width: auto;
      max-width: none;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #6b7280;
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #7c3aed;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1rem 0;
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .text-muted {
      color: #6b7280;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .mt-2 {
      margin-top: 0.5rem;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .ml-2 {
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
    function initializeReact() {
      if (!window.React || !window.ReactDOM) {
        setTimeout(initializeReact, 100);
        return;
      }

      const e = React.createElement;
      const container = document.getElementById('root');
      if (!container) {
        console.error('Root element not found');
        return;
      }

      const root = ReactDOM.createRoot(container);

      function App() {
        const [selection, setSelection] = React.useState([]);
        const [filteredSelection, setFilteredSelection] = React.useState([]);
        const [results, setResults] = React.useState([]);
        const [isReviewing, setIsReviewing] = React.useState(false);
        const [textStyles, setTextStyles] = React.useState([]);
        const [selectedStyles, setSelectedStyles] = React.useState(['no-style']);
        const [stats, setStats] = React.useState({
          totalNodes: 0,
          textNodes: 0,
          totalCharacters: 0,
          totalWords: 0,
          selectedTextNodes: 0
        });

        const NO_STYLE_OPTION = {
          id: 'no-style',
          name: 'No Style Text'
        };

        const filterSelectionByStyles = (nodes, selectedStyleIds) => {
          if (!nodes) return [];
          return nodes.filter(node => 
            node.type === 'TEXT' && 
            (
              (node.styleId && selectedStyleIds.includes(node.styleId)) ||
              (!node.styleId && selectedStyleIds.includes('no-style'))
            )
          );
        };

        React.useEffect(() => {
          function handleMessage(event) {
            const message = event.data.pluginMessage;
            if (!message) return;

            switch (message.type) {
              case 'selection-update':
                const newSelection = message.selection;
                setSelection(newSelection);
                const filtered = selectedStyles.length > 0 
                  ? filterSelectionByStyles(newSelection, selectedStyles)
                  : newSelection.filter(node => node.type === 'TEXT');
                setFilteredSelection(filtered);
                setStats(prevStats => ({
                  ...message.stats,
                  selectedTextNodes: filtered.length
                }));
                break;
              case 'text-styles-update':
                if (Array.isArray(message.styles)) {
                  setTextStyles(message.styles);
                }
                break;
              case 'review-complete':
                setResults(message.results);
                setIsReviewing(false);
                break;
            }
          }

          window.addEventListener('message', handleMessage);
          parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
          parent.postMessage({ pluginMessage: { type: 'get-text-styles' } }, '*');

          return () => {
            window.removeEventListener('message', handleMessage);
          };
        }, [selectedStyles]);

        React.useEffect(() => {
          const filtered = selectedStyles.length > 0 
            ? filterSelectionByStyles(selection, selectedStyles)
            : selection;
          setFilteredSelection(filtered);
          setStats(prevStats => ({
            ...prevStats,
            selectedTextNodes: filtered.length
          }));
        }, [selectedStyles, selection]);

        const handleStyleToggle = (styleId) => {
          if (styleId === 'no-style') return;
          setSelectedStyles(prev => {
            const newSelectedStyles = prev.includes(styleId)
              ? prev.filter(id => id !== styleId)
              : [...prev, styleId];
            return newSelectedStyles.includes('no-style') 
              ? newSelectedStyles 
              : [...newSelectedStyles, 'no-style'];
          });
        };

        const handleStartReview = () => {
          setIsReviewing(true);
          setResults([]);
          parent.postMessage({
            pluginMessage: {
              type: 'start-review',
              selectedStyles,
              nodesToReview: filteredSelection.map(node => node.id)
            }
          }, '*');
        };

        const handleFixIssue = (nodeId, suggestion) => {
          parent.postMessage({
            pluginMessage: {
              type: 'fix-text',
              nodeId,
              suggestion
            }
          }, '*');
        };

        return e('div', { className: 'space-y-6' },
          // Logo
          e('div', { className: 'logo' },
            e('div', {
              dangerouslySetInnerHTML: {
                __html: `<svg width="770" height="300" viewBox="0 0 770 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M35 162H305" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
                  <path d="M74.541 257.459L265.46 66.5402" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
                  <path d="M74.541 66.541L265.46 257.46" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
                  <path d="M170 27L170 162" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
                  <path d="M655.104 267.999L638.184 218.859H652.134L664.014 254.319L659.154 254.229L672.384 218.859H684.084L697.224 254.229L692.364 254.319L704.244 218.859H718.284L701.274 267.999H689.574L675.894 230.019H680.574L666.804 267.999H655.104Z" fill="#7D41E8"/>
                  <path d="M613.795 269.079C608.575 269.079 604.045 267.939 600.205 265.659C596.365 263.319 593.395 260.199 591.295 256.299C589.195 252.399 588.145 248.079 588.145 243.339C588.145 238.419 589.225 234.039 591.385 230.199C593.605 226.359 596.575 223.329 600.295 221.109C604.015 218.889 608.215 217.779 612.895 217.779C616.795 217.779 620.245 218.409 623.245 219.669C626.245 220.869 628.765 222.579 630.805 224.799C632.905 227.019 634.495 229.599 635.575 232.539C636.655 235.419 637.195 238.569 637.195 241.989C637.195 242.949 637.135 243.909 637.015 244.869C636.955 245.769 636.805 246.549 636.565 247.209H599.755V237.309H628.915L622.525 241.989C623.125 239.409 623.095 237.129 622.435 235.149C621.775 233.109 620.605 231.519 618.925 230.379C617.305 229.179 615.295 228.579 612.895 228.579C610.555 228.579 608.545 229.149 606.865 230.289C605.185 231.429 603.925 233.109 603.085 235.329C602.245 237.549 601.915 240.249 602.095 243.429C601.855 246.189 602.185 248.619 603.085 250.719C603.985 252.819 605.365 254.469 607.225 255.669C609.085 256.809 611.335 257.379 613.975 257.379C616.375 257.379 618.415 256.899 620.095 255.939C621.835 254.979 623.185 253.659 624.145 251.979L634.945 257.109C633.985 259.509 632.455 261.609 630.355 263.409C628.315 265.209 625.885 266.619 623.065 267.639C620.245 268.599 617.155 269.079 613.795 269.079Z" fill="#7D41E8"/>
                  <path d="M569.746 267.999V218.859H583.246V267.999H569.746ZM569.746 214.449V200.949H583.246V214.449H569.746Z" fill="#7D41E8"/>
                  <path d="M535.752 267.999L516.402 218.859H530.982L544.392 256.029H538.812L552.222 218.859H566.802L547.452 267.999H535.752Z" fill="#7D41E8"/>
                  <path d="M492.892 269.079C487.672 269.079 483.142 267.939 479.302 265.659C475.462 263.319 472.492 260.199 470.392 256.299C468.292 252.399 467.242 248.079 467.242 243.339C467.242 238.419 468.322 234.039 470.482 230.199C472.702 226.359 475.672 223.329 479.392 221.109C483.112 218.889 487.312 217.779 491.992 217.779C495.892 217.779 499.342 218.409 502.342 219.669C505.342 220.869 507.862 222.579 509.902 224.799C512.002 227.019 513.592 229.599 514.672 232.539C515.752 235.419 516.292 238.569 516.292 241.989C516.292 242.949 516.232 243.909 516.112 244.869C516.052 245.769 515.902 246.549 515.662 247.209H478.852V237.309H508.012L501.622 241.989C502.222 239.409 502.192 237.129 501.532 235.149C500.872 233.109 499.702 231.519 498.022 230.379C496.402 229.179 494.392 228.579 491.992 228.579C489.652 228.579 487.642 229.149 485.962 230.289C484.282 231.429 483.022 233.109 482.182 235.329C481.342 237.549 481.012 240.249 481.192 243.429C480.952 246.189 481.282 248.619 482.182 250.719C483.082 252.819 484.462 254.469 486.322 255.669C488.182 256.809 490.432 257.379 493.072 257.379C495.472 257.379 497.512 256.899 499.192 255.939C500.932 254.979 502.282 253.659 503.242 251.979L514.042 257.109C513.082 259.509 511.552 261.609 509.452 263.409C507.412 265.209 504.982 266.619 502.162 267.639C499.342 268.599 496.252 269.079 492.892 269.079Z" fill="#7D41E8"/>
                  <path d="M415.908 267.999V200.949H441.558C446.178 200.949 450.258 201.759 453.798 203.379C457.398 204.999 460.218 207.399 462.258 210.579C464.298 213.759 465.318 217.689 465.318 222.369C465.318 226.929 464.268 230.829 462.168 234.069C460.068 237.249 457.248 239.649 453.708 241.269L469.008 267.999H453.348L436.788 238.389L445.788 243.699H429.858V267.999H415.908ZM429.858 231.549H441.648C443.628 231.549 445.338 231.159 446.778 230.379C448.218 229.599 449.328 228.519 450.108 227.139C450.948 225.759 451.368 224.169 451.368 222.369C451.368 220.509 450.948 218.889 450.108 217.509C449.328 216.129 448.218 215.049 446.778 214.269C445.338 213.489 443.628 213.099 441.648 213.099H429.858V231.549Z" fill="#7D41E8"/>
                  <path d="M393.068 267.999V200.949H407.018V267.999H393.068Z" fill="#7D41E8"/>
                  <path d="M357.581 269.079C352.301 269.079 347.591 267.969 343.451 265.749C339.311 263.529 336.041 260.499 333.641 256.659C331.301 252.759 330.131 248.349 330.131 243.429V200.949H344.081V242.529C344.081 245.169 344.651 247.569 345.791 249.729C346.991 251.829 348.611 253.479 350.651 254.679C352.691 255.879 355.001 256.479 357.581 256.479C360.221 256.479 362.531 255.879 364.511 254.679C366.551 253.479 368.141 251.829 369.281 249.729C370.481 247.569 371.081 245.169 371.081 242.529V200.949H385.031V243.429C385.031 248.349 383.831 252.759 381.431 256.659C379.091 260.499 375.851 263.529 371.711 265.749C367.571 267.969 362.861 269.079 357.581 269.079Z" fill="#7D41E8"/>
                </svg>`
              }
            })
          ),
          
          // 配置区域
          e('div', { className: 'section' },
            e('div', { className: 'section-header' },
              e('h2', { className: 'section-title' }, 'Configuration')
            ),
            e('div', { className: 'section-content' },
              e('p', { className: 'text-sm text-muted mb-2' }, 'Select text styles to check'),
              e('div', null,
                textStyles.length === 0 
                  ? e('div', { className: 'empty-state' },
                      e('p', null, 'No text styles found')
                    )
                  : e('div', { className: 'style-list' },
                      [...textStyles, NO_STYLE_OPTION].map(style =>
                        e('label', {
                          key: style.id,
                          className: `style-item ${selectedStyles.includes(style.id) ? 'selected' : ''}`,
                          onClick: (e) => {
                            if (style.id !== 'no-style') {
                              handleStyleToggle(style.id);
                            }
                          }
                        },
                          e('input', {
                            type: 'checkbox',
                            className: 'style-checkbox',
                            checked: selectedStyles.includes(style.id),
                            disabled: style.id === 'no-style',
                            onChange: (e) => {
                              if (style.id !== 'no-style') {
                                handleStyleToggle(style.id);
                              }
                            }
                          }),
                          e('span', {
                            className: `style-name ${style.id === 'no-style' ? 'text-gray-600' : ''}`
                          }, style.name || 'Unnamed Style')
                        )
                      )
                  )
              ),
              e('button', {
                onClick: handleStartReview,
                className: `btn btn-primary ${isReviewing ? 'opacity-50 cursor-not-allowed' : ''}`,
                disabled: isReviewing
              }, isReviewing ? 'Reviewing...' : 'Start Review')
            )
          ),

          // 选择区域
          selection.length > 0 && e('div', { className: 'section' },
            e('div', { className: 'section-header' },
              e('h2', { className: 'section-title' }, 'Selected Elements'),
              e('span', { className: 'badge badge-purple' }, 
                selectedStyles.length > 0 
                  ? `${filteredSelection.length} filtered items`
                  : `${selection.length} items`
              )
            ),
            e('div', { className: 'section-content' },
              e('div', { className: 'stats' },
                e('div', { className: 'stat-item' },
                  e('div', { className: 'stat-value' }, 
                    stats.textNodes
                  ),
                  e('div', { className: 'stat-label' }, 'Text Layers')
                ),
                e('div', { className: 'stat-item' },
                  e('div', { className: 'stat-value' }, stats.totalNodes),
                  e('div', { className: 'stat-label' }, 'Total Layers')
                )
              ),
              e('div', { className: 'divider' }),
              e('div', { className: 'space-y-2' },
                (selectedStyles.length > 0 ? filteredSelection : selection).slice(0, 2).map(item =>
                  e('div', {
                    key: item.id,
                    className: 'flex items-center justify-between p-2 bg-gray-50 rounded'
                  },
                    e('div', { className: 'space-y-1' },
                      e('div', { className: 'text-sm font-medium' }, item.name),
                      e('div', { className: 'text-xs text-muted' }, item.type)
                    )
                  )
                ),
                (selectedStyles.length > 0 ? filteredSelection : selection).length > 2 &&
                  e('div', {
                    className: 'flex items-center justify-center p-2 bg-gray-50 rounded text-sm text-muted'
                  }, `... and ${(selectedStyles.length > 0 ? filteredSelection : selection).length - 2} more items`)
              )
            )
          ),

          // 结果区域
          (results.length > 0 || isReviewing) && e('div', { className: 'section' },
            e('div', { className: 'section-header' },
              e('h2', { className: 'section-title' }, 'Review Results'),
              results.length > 0 && e('span', { className: 'badge badge-purple' }, `${results.length} issues`)
            ),
            e('div', { className: 'section-content' },
              isReviewing
                ? e('div', { className: 'loading' },
                    e('div', { className: 'loading-spinner' }),
                    e('span', null, 'Reviewing...')
                  )
                : results.length === 0
                  ? e('div', { className: 'empty-state' },
                      e('p', null, 'No issues found')
                    )
                  : e('div', { className: 'space-y-4' },
                      results.map((result, index) =>
                        e('div', {
                          key: index,
                          className: 'issue-item'
                        },
                          e('div', { className: 'issue-header' },
                            e('div', { className: 'flex items-center justify-between' },
                              e('div', { className: 'text-sm font-medium' }, result.nodeName),
                              e('button', {
                                className: 'fix-all-button',
                                onClick: () => {
                                  result.issues.forEach(issue => {
                                    handleFixIssue(result.nodeId, issue.suggestion);
                                  });
                                }
                              }, 'Fix All')
                            )
                          ),
                          e('div', { className: 'issue-text' }, result.text),
                          e('div', { className: 'space-y-2 mt-2' },
                            result.issues.map((issue, issueIndex) =>
                              e('div', { 
                                key: issueIndex,
                                className: 'flex items-center justify-between text-sm p-2 bg-gray-50 rounded'
                              },
                                e('span', null,
                                  'Change ',
                                  e('span', { className: 'font-medium' }, issue.word),
                                  ' to ',
                                  e('span', { className: 'font-medium text-purple-600' }, issue.suggestion)
                                ),
                                e('div', { className: 'flex gap-2' },
                                  e('button', {
                                    className: 'go-button',
                                    onClick: () => {
                                      parent.postMessage({
                                        pluginMessage: {
                                          type: 'go-to-node',
                                          nodeId: result.nodeId
                                        }
                                      }, '*');
                                    }
                                  }, 'Go'),
                                  e('button', {
                                    className: 'fix-button',
                                    onClick: () => handleFixIssue(result.nodeId, issue.suggestion)
                                  }, 'Fix')
                                )
                              )
                            )
                          )
                        )
                      )
                    )
            )
          )
        );
      }

      try {
        root.render(e(App));
      } catch (error) {
        console.error('Error rendering React app:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeReact);
    } else {
      initializeReact();
    }
  </script>
</body>
</html> 