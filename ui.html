<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UI Review Plugin</title>
  <style>
    body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: white;
      color: #333;
    }

    .space-y-6 > * + * {
      margin-top: 1rem;
    }

    .section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    .section:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-content {
      padding: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.875rem;
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      outline: none;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: #7c3aed;
      color: white;
    }

    .btn-primary:hover {
      background-color: #6d28d9;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
      background-color: #f3f4f6;
      color: #374151;
      gap: 0.25rem;
    }

    .badge-purple {
      background-color: #f5f3ff;
      color: #7c3aed;
    }

    .style-list {
      max-height: 120px;
      overflow-y: auto;
      margin-bottom: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      padding: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .style-item {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
      background: white;
      font-size: 0.75rem;
      min-width: calc(33.333% - 0.5rem);
      flex: 0 1 auto;
    }

    .style-item:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }

    .style-item.selected {
      background-color: #f5f3ff;
      border-color: #7c3aed;
    }

    .style-checkbox {
      width: 0.875rem;
      height: 0.875rem;
      margin-right: 0.5rem;
      border-radius: 3px;
      border: 2px solid #d1d5db;
      position: relative;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .style-checkbox:checked {
      background-color: #7c3aed;
      border-color: #7c3aed;
    }

    .style-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 1px;
      width: 3px;
      height: 6px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .style-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .issue-item {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      padding: 1rem;
      transition: all 0.2s ease;
    }

    .issue-item:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .issue-header {
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .issue-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      background-color: #f9fafb;
      padding: 0.75rem;
      border-radius: 6px;
      margin: 0.75rem 0;
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
      font-size: 0.875rem;
    }

    .fix-button {
      background-color: #7c3aed;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .fix-button:hover {
      background-color: #6d28d9;
    }

    .fix-all-button {
      background-color: #7c3aed;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .fix-all-button:hover {
      background-color: #6d28d9;
    }

    .go-button {
      background-color: #10b981;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      margin-left: 0.5rem;
    }

    .go-button:hover {
      background-color: #059669;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .stat-item {
      background-color: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      background-color: #f3f4f6;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #6b7280;
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #7c3aed;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1rem 0;
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .text-muted {
      color: #6b7280;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .mt-2 {
      margin-top: 0.5rem;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .ml-2 {
      margin-left: 0.5rem;
    }

    .h-full {
      height: 100%;
    }

    .h-12 {
      height: 3rem;
    }

    .w-12 {
      width: 3rem;
    }

    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }

    .mb-4 {
      margin-bottom: 1rem;
    }

    .text-center {
      text-align: center;
    }

    .text-lg {
      font-size: 1.125rem;
    }

    .text-gray-900 {
      color: #111827;
    }

    .text-gray-500 {
      color: #6b7280;
    }

    .text-gray-400 {
      color: #9ca3af;
    }

    .font-medium {
      font-weight: 500;
    }

    .flex-1 {
      flex: 1 1 0%;
    }

    .flex-col {
      flex-direction: column;
    }

    .justify-center {
      justify-content: center;
    }

    /* Tab 导航样式 */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .header-logo {
      width: 120px;
      height: auto;
    }

    .header-logo svg {
      width: 100%;
      height: auto;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      background-color: #f3f4f6;
      padding: 0.25rem;
      border-radius: 0.5rem;
      margin-left: auto;
    }

    .tab {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      color: #6b7280;
    }

    .tab:hover {
      color: #111827;
      background-color: rgba(255, 255, 255, 0.5);
    }

    .tab.active {
      background-color: white;
      color: #111827;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
  <script>
    let activeTab = 'text'; // 默认选中文案 tab

    function setActiveTab(tabId) {
      activeTab = tabId;
      document.querySelectorAll('.tab').forEach(tab => {
        if (tab.dataset.id === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // 发送消息给插件
      parent.postMessage({ 
        pluginMessage: { 
          type: 'tab-change',
          tab: tabId 
        } 
      }, '*');
    }

    function initializeReact() {
      if (!window.React || !window.ReactDOM) {
        setTimeout(initializeReact, 100);
        return;
      }

      const e = React.createElement;
      const container = document.getElementById('root');
      if (!container) {
        console.error('Root element not found');
        return;
      }

      const root = ReactDOM.createRoot(container);

      function App() {
        const [selection, setSelection] = React.useState([]);
        const [filteredSelection, setFilteredSelection] = React.useState([]);
        const [results, setResults] = React.useState([]);
        const [isReviewing, setIsReviewing] = React.useState(false);
        const [textStyles, setTextStyles] = React.useState([]);
        const [selectedStyles, setSelectedStyles] = React.useState(['no-style']);
        const [currentTab, setCurrentTab] = React.useState('text');
        const [stats, setStats] = React.useState({
          totalNodes: 0,
          textNodes: 0,
          totalCharacters: 0,
          totalWords: 0,
          selectedTextNodes: 0
        });

        const NO_STYLE_OPTION = {
          id: 'no-style',
          name: 'No Style Text'
        };

        const filterSelectionByStyles = (nodes, selectedStyleIds) => {
          if (!nodes) return [];
          return nodes.filter(node => 
            node.type === 'TEXT' && 
            (
              (node.styleId && selectedStyleIds.includes(node.styleId)) ||
              (!node.styleId && selectedStyleIds.includes('no-style'))
            )
          );
        };

        React.useEffect(() => {
          function handleMessage(event) {
            const message = event.data.pluginMessage;
            if (!message) return;

            switch (message.type) {
              case 'tab-change':
                setCurrentTab(message.tab);
                setResults([]);
                setIsReviewing(false);
                break;
              case 'selection-update':
                const newSelection = message.selection;
                setSelection(newSelection);
                const filtered = selectedStyles.length > 0 
                  ? filterSelectionByStyles(newSelection, selectedStyles)
                  : newSelection.filter(node => node.type === 'TEXT');
                setFilteredSelection(filtered);
                setStats(prevStats => ({
                  ...message.stats,
                  selectedTextNodes: filtered.length
                }));
                break;
              case 'text-styles-update':
                if (Array.isArray(message.styles)) {
                  setTextStyles(message.styles);
                }
                break;
              case 'review-complete':
                setResults(message.results);
                setIsReviewing(false);
                break;
            }
          }

          window.addEventListener('message', handleMessage);
          parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
          parent.postMessage({ pluginMessage: { type: 'get-text-styles' } }, '*');

          return () => {
            window.removeEventListener('message', handleMessage);
          };
        }, [selectedStyles]);

        const handleStyleToggle = (styleId) => {
          if (styleId === 'no-style') return;
          setSelectedStyles(prev => {
            const newSelectedStyles = prev.includes(styleId)
              ? prev.filter(id => id !== styleId)
              : [...prev, styleId];
            return newSelectedStyles.includes('no-style') 
              ? newSelectedStyles 
              : [...newSelectedStyles, 'no-style'];
          });
        };

        const handleStartReview = () => {
          setIsReviewing(true);
          setResults([]);
          parent.postMessage({
            pluginMessage: {
              type: 'start-review',
              selectedStyles,
              nodesToReview: filteredSelection.map(node => node.id)
            }
          }, '*');
        };

        const handleFixIssue = (nodeId, suggestion) => {
          parent.postMessage({
            pluginMessage: {
              type: 'fix-text',
              nodeId,
              suggestion
            }
          }, '*');
        };

        // 文案检查页面
        const TextReviewPage = () => {
          return e('div', { className: 'space-y-6' },
            // 配置区域
            e('div', { className: 'section' },
              e('div', { className: 'section-header' },
                e('h2', { className: 'section-title' }, 'Configuration')
              ),
              e('div', { className: 'section-content' },
                e('p', { className: 'text-sm text-muted mb-2' }, 'Select text styles to check'),
                e('div', null,
                  textStyles.length === 0 
                    ? e('div', { className: 'empty-state' },
                        e('p', null, 'No text styles found')
                      )
                    : e('div', { className: 'style-list' },
                        [...textStyles, NO_STYLE_OPTION].map(style =>
                          e('label', {
                            key: style.id,
                            className: `style-item ${selectedStyles.includes(style.id) ? 'selected' : ''}`,
                            onClick: (e) => {
                              if (style.id !== 'no-style') {
                                handleStyleToggle(style.id);
                              }
                            }
                          },
                            e('input', {
                              type: 'checkbox',
                              className: 'style-checkbox',
                              checked: selectedStyles.includes(style.id),
                              disabled: style.id === 'no-style',
                              onChange: (e) => {
                                if (style.id !== 'no-style') {
                                  handleStyleToggle(style.id);
                                }
                              }
                            }),
                            e('span', {
                              className: `style-name ${style.id === 'no-style' ? 'text-gray-600' : ''}`
                            }, style.name || 'Unnamed Style')
                          )
                        )
                    )
                ),
                e('button', {
                  onClick: handleStartReview,
                  className: `btn btn-primary ${isReviewing ? 'opacity-50 cursor-not-allowed' : ''}`,
                  disabled: isReviewing
                }, isReviewing ? 'Reviewing...' : 'Start Review')
              )
            ),

            // 选择区域
            selection.length > 0 && e('div', { className: 'section' },
              e('div', { className: 'section-header' },
                e('h2', { className: 'section-title' }, 'Selected Elements'),
                e('span', { className: 'badge badge-purple' }, 
                  selectedStyles.length > 0 
                    ? `${filteredSelection.length} filtered items`
                    : `${selection.length} items`
                )
              ),
              e('div', { className: 'section-content' },
                e('div', { className: 'stats' },
                  e('div', { className: 'stat-item' },
                    e('div', { className: 'stat-value' }, 
                      stats.textNodes
                    ),
                    e('div', { className: 'stat-label' }, 'Text Layers')
                  ),
                  e('div', { className: 'stat-item' },
                    e('div', { className: 'stat-value' }, stats.totalNodes),
                    e('div', { className: 'stat-label' }, 'Total Layers')
                  )
                ),
                e('div', { className: 'divider' }),
                e('div', { className: 'space-y-2' },
                  (selectedStyles.length > 0 ? filteredSelection : selection).slice(0, 2).map(item =>
                    e('div', {
                      key: item.id,
                      className: 'flex items-center justify-between p-2 bg-gray-50 rounded'
                    },
                      e('div', { className: 'space-y-1' },
                        e('div', { className: 'text-sm font-medium' }, item.name),
                        e('div', { className: 'text-xs text-muted' }, item.type)
                      )
                    )
                  ),
                  (selectedStyles.length > 0 ? filteredSelection : selection).length > 2 &&
                    e('div', {
                      className: 'flex items-center justify-center p-2 bg-gray-50 rounded text-sm text-muted'
                    }, `... and ${(selectedStyles.length > 0 ? filteredSelection : selection).length - 2} more items`)
                )
              )
            ),

            // 结果区域
            (results.length > 0 || isReviewing) && e('div', { className: 'section' },
              e('div', { className: 'section-header' },
                e('h2', { className: 'section-title' }, 'Review Results'),
                results.length > 0 && e('span', { className: 'badge badge-purple' }, `${results.length} issues`)
              ),
              e('div', { className: 'section-content' },
                isReviewing
                  ? e('div', { className: 'loading' },
                      e('div', { className: 'loading-spinner' }),
                      e('span', null, 'Reviewing...')
                    )
                  : results.length === 0
                    ? e('div', { className: 'empty-state' },
                        e('p', null, 'No issues found')
                      )
                    : e('div', { className: 'space-y-4' },
                        results.map((result, index) =>
                          e('div', {
                            key: index,
                            className: 'issue-item'
                          },
                            e('div', { className: 'issue-header' },
                              e('div', { className: 'flex items-center justify-between' },
                                e('div', { className: 'text-sm font-medium' }, result.nodeName),
                                e('button', {
                                  className: 'fix-all-button',
                                  onClick: () => {
                                    result.issues.forEach(issue => {
                                      handleFixIssue(result.nodeId, issue.suggestion);
                                    });
                                  }
                                }, 'Fix All')
                              )
                            ),
                            e('div', { className: 'issue-text' }, result.text),
                            e('div', { className: 'space-y-2 mt-2' },
                              result.issues.map((issue, issueIndex) =>
                                e('div', { 
                                  key: issueIndex,
                                  className: 'flex items-center justify-between text-sm p-2 bg-gray-50 rounded'
                                },
                                  e('span', null,
                                    'Change ',
                                    e('span', { className: 'font-medium' }, issue.word),
                                    ' to ',
                                    e('span', { className: 'font-medium text-purple-600' }, issue.suggestion)
                                  ),
                                  e('div', { className: 'flex gap-2' },
                                    e('button', {
                                      className: 'go-button',
                                      onClick: () => {
                                        parent.postMessage({
                                          pluginMessage: {
                                            type: 'go-to-node',
                                            nodeId: result.nodeId
                                          }
                                        }, '*');
                                      }
                                    }, 'Go'),
                                    e('button', {
                                      className: 'fix-button',
                                      onClick: () => handleFixIssue(result.nodeId, issue.suggestion)
                                    }, 'Fix')
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
              )
            )
          );
        };

        // 圆角检查页面
        const RadiusReviewPage = () => {
          return e('div', { className: 'flex flex-col h-full' },
            e('div', { className: 'flex-1 flex items-center justify-center' },
              e('div', { className: 'text-center' },
                e('div', { className: 'mb-4 text-gray-400' },
                  e('svg', {
                    className: 'mx-auto h-12 w-12',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                    'aria-hidden': 'true'
                  },
                    e('path', {
                      strokeLinecap: 'round',
                      strokeLinejoin: 'round',
                      strokeWidth: 2,
                      d: 'M4 5a2 2 0 012-2h12a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V5z'
                    })
                  )
                ),
                e('h3', { className: 'mb-2 text-lg font-medium text-gray-900' }, '圆角规范检查'),
                e('p', { className: 'mb-4 text-sm text-gray-500' }, '选择需要检查的元素，点击下方按钮开始检查圆角是否符合规范'),
                e('button', {
                  className: 'btn btn-primary',
                  onClick: () => {
                    parent.postMessage({
                      pluginMessage: {
                        type: 'start-radius-review'
                      }
                    }, '*');
                  }
                }, '开始检查')
              )
            )
          );
        };

        // 根据当前 Tab 返回对应的页面
        return e(React.Fragment, null,
          currentTab === 'text' ? TextReviewPage() : RadiusReviewPage()
        );
      }

      try {
        root.render(e(App));
      } catch (error) {
        console.error('Error rendering React app:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeReact);
    } else {
      initializeReact();
    }
  </script>
</head>
<body>
  <div class="header">
    <div class="header-logo">
      <svg width="770" height="300" viewBox="0 0 770 300" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M35 162H305" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
        <path d="M74.541 257.459L265.46 66.5402" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
        <path d="M74.541 66.541L265.46 257.46" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
        <path d="M170 27L170 162" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="36"/>
      </svg>
    </div>
    <div class="tabs">
      <button class="tab active" data-id="text" onclick="setActiveTab('text')">文案</button>
      <button class="tab" data-id="radius" onclick="setActiveTab('radius')">圆角</button>
    </div>
  </div>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</body>
</html> 